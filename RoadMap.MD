## Описание

### Точка входа

Точкой входа является REST-Апи. Предоставляет следующие методы:

   1. Выполнить рассылку:
      - описание: основной метод, выполняет асинхронную регистрацию отправки сообщения в нужном виртуальном канале, отдает ответ не дожидаясь выполнения отправки
      - структура URL: /api/send/{virtual-channel-name}
      - метод POST (регистрация рассылки)
      - GET параметры: опционально, имена и значения аналогичны полям тела запроса (будут использованы, если не переданы в теле запроса)
      - заголовки: Charset: UTF-8, Content-Type: application/x-www-form-urlencoded
      - тело содержит следующие поля:
         - message: обязателен, однострочная или многострочная строка, допустимы латинские и кириллические символы, а также знаки препинания
         - delay: опционален, задержка отправки сообщений (в секундах) после регистрации, если не передан - отправка без задержки
      - примечание: данные из тела запроса имеют приоритет над GET параметрами: если данные переданы обоими вариантами сразу - будут использованы данные тела запроса
      - ответ: 204, без данных при успешной регистрации; 500, json объект с кодом и описанием ошибки в случае ошибок выполнения; 422, json объект с кодом и описанием ошибки в случае ошибок валидации входящих данных
   2. Проверка состояния (пинг):
      - описание: вспомогательный метод, позволяет проверить доступность метода 
      - структура URL: /api/ping
      - метод GET
      - заголовки: Charset: UTF-8
      - тело: не требуется
      - ответ: 204, без данных если сервис доступен; 503, без данных в случае, если сервис в режиме обслуживания

### Обработка запросов

Жизненный цикл запросов:

   1. Для метода "выполнить рассылку":
      1. если сервис находится на обслуживании, отдает пустой http-ответ с кодом 503, иначе продолжает выполнение метода по шагам
      2. получение данных из запроса
      3. валидация данных
      4. размещение задания в очереди указанного виртуального канала
      5. отдает http-ответ с результатом выполнения операции (не дожидаясь выполнения задания на обработку очереди)
   2. Для метода "Проверка состояния":
      1. читается текущая конфигурация - проверяется ключ Режима обслуживания
      2. Далее:
         - если режим обслуживания отключен - возвращаем пустой http-ответ с кодом 204
         - если режим обслуживания включен - возвращаем пустой http-ответ с кодом 503

### Состояние сервиса

Подразумевается, что работу сервиса можно приостановить, например, для обслуживания

Установка статуса выполняется через консольную команду непосредственно, где сервис развернут

Если сервис приостановлен - выполнение заданий из очередей не производиться, постановка заданий в очереди не производиться

### Валидация данных

   1. все входящие данные можно разделить на две группы:
      - управляющие, данные, которые влияют на поведение сервиса
      - пользовательские, данные, которые проходят через сервис и не влияют на его поведение
   2. Общие правила, применяемые ко всем валидируемым данным:
      - обязательное поле, сервис обязан вернуть ошибку, в случае если поле не представлено или его значение пусто (пустая строка, None)
   3. Правила, применяемые к управляющим данным:
      - число, значением поля является целое число, либо строка состоящая только из цифр и возможного знака минус в начале
      - строка, значением поля является непустая строка без знаков переноса строки и перевода каретки (\n или \r\n)
   4. Правила, применяемые к пользовательским данным:
      - текст, определяется исполнителем задания - шаблон регулярного выражения предоставляет исполнитель задания, данный шаблон позволяет проверить текст на соответствие условиям удаленного сервиса, в который передается сообщение
      
### Виртуальный канал

Виртуальный канал - настраиваемая через конфигурацию обертка для очереди заданий для определенного исполнителя задания. Имя канала уникально

У каждого виртуального канала свой исполнитель задания (worker), который выполняет задания из очереди данного канала. Имя исполнителя задания указывается в конфигурации канала, объект исполнителя задания получает необходимые параметры при создании

Конфигурационный файл с виртуальными каналами имеет расширение YAML

Конфигурация виртуальных каналов читается в память/кеш при старте сервиса и не может быть изменена без его остановки

Обращение к виртуальным каналам производится через обертку, которая предоставляет следующие методы:

   1. Зарегистрировать виртуальный канал: вызывается при инициализации сервиса, создает объект виртуального канала, размещает его во внутреннюю коллекцию обертки, добавляет имя канала в список зарегистрированных каналов 
   2. Активировать виртуальный канал: вызывается при активации сервиса, запускает работу исполнителя задания, зарегистрированного у данного канала
   2. Деактивировать виртуальный канал: вызывается при остановке сервиса, добавляет в очередь канала задание, завершающее работу исполнителя задания, зарегистрированного у данного канала 
   3. Проверить наличие канала: проверяет наличие канала внутри обертки по его имени, возвращает true или false
   4. Создать задание в очереди на рассылку сообщения в определенном канале: вызывает внутри себя соответствующий метод у менеджера очереди соответствующего виртуального канала

### Менеджер очереди

Менеджер очереди является оберткой над встроенной или внешней реализацией очереди, которая предоставляет методы, необходимые для работы сервиса:

   1. добавить задачу в очередь - добавляет задачу на отправку сообщения в очередь
   2. получить задачу из очереди - извлекает ожидающую выполнения задачу из очереди
   3. отметить задачу выполненной - выполняемая данным исполнителем задача выполнена (удаляется из очереди)
   4. наличие задач в очереди - возвращает true или false в зависимости от наличия задач в очереди
   
### Исполнитель задания

Исполнителем задания является функция, в которой:

   1. при вызове передается менеджер очереди, из которой будут извлекаться задания для выполнения, а также параметры виртуального канала, необходимые для работы исполнителя задания
   2. в теле функции исполняется цикл, условием которого является статус сервиса: если сервис остановлен на обслуживание - цикл прерывается
   3. в теле цикла ожидаем задание из очереди, при поступлении задания - выполняем его

При выполнении задания ожидается следующая логика:

   1. подключение к удаленному сервису/службе
   2. передать сообщение (выполнить отправку сообщения в определенный сервис)
   3. получить ответ и разобрать его:
      - если передача успешна - завершаем выполнение задания
      - если не удается подключиться к сервису (удаленный сервис не доступен, нет доступа к сети и тп) - откладываем выполнение задания
      - если сервис не принимает сообщение - завершаем выполнение задания с занесением ошибки в лог
      
Предполагается реализовать следующие исполнители заданий:

   1. Telegram-bot - подключение к Telegram и передача сообщения в определенный чат
   2. null-task - данный объект не выполняет подключений, пишет только в логи свой вызов (скорее всего для тестов)
   3. SMS - рассылка по определенному набору номеров короткого сообщения через внешний сервис рассылки SMS-сообщений
   4. email - рассылка текстового сообщения набору адресов через внешний сервис почты
   
### Логирование:

Варианты и точки:
  - стандартные средства python
  - логирование входящих запросов в aiohttp
  - обертка для режима отладки и verbose-level с выводом в консоль, где запущен сервис
  - сохранение логов в БД/файлы на ротации
  
## План реализации

MVP предполагает:

   1. создание http сервера на базе aiohttp, на котором реализовано REST апи. В методе выполнения рассылки пока что без возможности отложить задание
   4. создание исполнителя задания по отправке сообщений в Телегу
   5. поддержка виртуальных каналов должна быть заложена, но на текущий момент конфигурация под единственный канал и исполнитель задания

Далее следующий функционал:

  1. Полноценная реализация виртуальных каналов
  2. Добавление null-task исполнителя задания
  3. Добавление базового набора тестов
  4. Настройка примитивного CI/CD
  5. Добавление возможности отложить отправку сообщения
  6. Расширение возможностей по работе с заданиями из очереди:
     1. если задание не выполнено с ошибкой подключения - отложить задание на фиксированное время, иначе завершить с ошибкой 
     2. добавить настраиваемую задержку перед повторной попыткой выполнения задания в виртуальном канале 
     3. добавить настраиваемое число повторных попыток выполнения задания в виртуальном канале
     4. добавить настраиваемое время жизни задачи после которого она отменяется в виртуальном канале
     5. добавить поддержку активации и деактивации исполнителей задания
  7. добавление консольной команды режима обслуживания
  8. добавление полноценного логирования
  9. Добавление не хватающих тестов (планируется выпуск тестов совместно с функциями, но может что-то упущено)
  10. Предрелизный рефакторинг
  11. Релиз версии 1.0
  12. Добавление исполнителей заданий в качестве пакетов расширений

## Вопросы/возможные фичи:
   
   1. Добавляем ли на какой-либо стадии конфигурацию докера (не забываем, что репозиторий открытый, и софтом в последствии может пользоваться кто-то еще)?
   2. Добавляем ли vagrantfile в сам репозиторий или это наш внутренний элемент (не забываем, что репозиторий открытый, и софтом в последствии может пользоваться кто-то еще)?
   3. Я добавлю конфигурации и под pipenv (Pipfile и Pipfile.lock) и под обычный venv + pip (requirements.txt)?
   4. в предложенном варианте можно сделать настройку, меняющее количество исполнителей задания в виртуальном канале - делаем?
